define(["jquery","atto_subtitle/constants","atto_subtitle/vtthelper","atto_subtitle/subtitleset","atto_subtitle/previewhelper","atto_subtitle/playerhelper"],function(a,b,c,d,e,f){return{controls:{},currentindex:!1,currentitemcontainer:null,editoropen:!1,init:function(a,b){d.init(a),e.init(d,b),f.init(b),this.initControls(),this.initTiles(),this.initEvents()},initControls:function(){this.controls.container=a("#poodllsubtitle_tiles"),this.controls.editor=a("#poodllsubtitle_editor"),this.controls.number=a("#poodllsubtitle_editor .numb_song"),this.controls.edstart=a("#poodllsubtitle_edstart"),this.controls.edend=a("#poodllsubtitle_edend"),this.controls.edpart=a("#poodllsubtitle_edpart"),this.controls.buttondelete=a("#poodllsubtitle_eddelete"),this.controls.buttonmergeup=a("#poodllsubtitle_edmergeup"),this.controls.buttonsplit=a("#poodllsubtitle_edsplit"),this.controls.buttonapply=a("#poodllsubtitle_edapply"),this.controls.buttoncancel=a("#poodllsubtitle_edcancel"),this.controls.buttonaddnew=a("#poodllsubtitle_addnew"),this.controls.buttonstartsetnow=a("#poodllsubtitle_startsetnow"),this.controls.buttonendsetnow=a("#poodllsubtitle_endsetnow"),this.controls.buttonstartbumpup=a("#poodllsubtitle_startbumpup"),this.controls.buttonstartbumpdown=a("#poodllsubtitle_startbumpdown"),this.controls.buttonendbumpup=a("#poodllsubtitle_endbumpup"),this.controls.buttonendbumpdown=a("#poodllsubtitle_endbumpdown")},hideEditor:function(){this.controls.editor.detach(),this.controls.editor.hide(),this.editoropen=!1},restoreTile:function(){var a=d.fetchItem(this.currentindex),b=this.fetchNewTextTile(this.currentindex,a.start,a.end,a.part);this.hideEditor(),this.currentitemcontainer.append(b)},editorToTile:function(){var b=c.timeString2ms(a(this.controls.edstart).val()),e=c.timeString2ms(a(this.controls.edend).val()),f=this.validateTimes(this.currentindex,b,e);if(!f)return a(this.currentitemcontainer).addClass("warning"),!1;var g=a(this.controls.edpart).val();d.updateItem(this.currentindex,b,e,g);var h=this.fetchNewTextTile(this.currentindex,b,e,g);return this.hideEditor(),this.currentitemcontainer.append(h),a(this.currentitemcontainer).removeClass("warning"),!0},initEvents:function(){var f=this;this.controls.container.on("click",".poodllsubtitle_tt",function(){var b=parseInt(a(this).parent().attr("data-id"));1==f.editoropen&&f.editorToTile(f.controls,f.currentindex,f.currentitemcontainer),f.currentindex=b,f.currentitemcontainer=a(this).parent(),f.shiftEditor(f.currentindex,f.currentitemcontainer),e.setPosition(f.currentindex)}),this.controls.buttondelete.click(function(){result=confirm("Warning! This tile is going to be deleted!"),result&&(f.restoreTile(),d.removeItem(f.currentindex),f.syncFrom(f.currentindex),e.updateLabel())}),this.controls.buttonmergeup.click(function(){f.editorToTile(),d.mergeUp(f.currentindex),f.syncFrom(f.currentindex-1),e.setPosition(f.currentindex-1)}),this.controls.buttonsplit.click(function(){f.editorToTile(),d.split(f.currentindex),f.syncFrom(f.currentindex),e.updateLabel()}),this.controls.buttonapply.click(function(){f.editorToTile(),e.updateLabel()}),this.controls.buttoncancel.click(function(){f.restoreTile()}),this.controls.buttonstartsetnow.click(function(){var a=e.fetchCurrentTime(),b=c.ms2TimeString(a);f.controls.edstart.val(b)}),this.controls.buttonendsetnow.click(function(){var a=e.fetchCurrentTime(),b=c.ms2TimeString(a);f.controls.edend.val(b)}),this.controls.buttonstartbumpup.click(function(){f.doBump(f.controls.edstart,b.bumpinterval)}),this.controls.buttonstartbumpdown.click(function(){f.doBump(f.controls.edstart,-1*b.bumpinterval)}),this.controls.buttonendbumpup.click(function(){f.doBump(f.controls.edend,b.bumpinterval)}),this.controls.buttonendbumpdown.click(function(){f.doBump(f.controls.edend,-1*b.bumpinterval)}),this.controls.edstart.keypress(function(a){var b=a.keyCode?a.keyCode:a.which;b>=48&&b<=57||58==b||46==b||a.preventDefault()}),this.controls.buttonaddnew.click(function(){var a=d.fetchCount(),b=a,c=0;if(a>0){var e=d.fetchItem(a-1);c=e.end+500}var g=c+2e3;d.addItem(b,c,g,"");var h=f.fetchNewTextTileContainer(b,c,g,"");f.controls.container.append(h)}),e.highlightItem=this.highlightContainer,e.deHighlightAll=this.deHighlightAll},doBump:function(a,b){var d=a.val();if(c.validateTimeString(d)){var e=c.timeString2ms(d);e+=b,e<0&&(e=0),d=c.ms2TimeString(e),a.val(d)}},initTiles:function(){var a=this.controls.container,b=this,c=d.fetchCount();if(c>0)for(var e=0;e<c;e++){var f=d.fetchItem(e),g=b.fetchNewTextTileContainer(e,f.start,f.end,f.part);a.append(g)}},validateTimes:function(a,b,c){if(c<=b)return!1;var e=!1,f=!1;return a>0&&(e=d.fetchItem(a-1)),a<d.fetchCount()-1&&(f=d.fetchItem(a+1)),!(e&&e.end>b)&&!(f&&f.start<c)},shiftEditor:function(b,e){this.controls.editor.hide();var f=d.fetchItem(b),g=c.ms2TimeString(f.start);a(this.controls.edstart).val(g);var h=c.ms2TimeString(f.end);a(this.controls.edend).val(h);var i=f.part;a(this.controls.edpart).val(i),e.empty(),e.append(this.controls.editor),this.controls.editor.show(),this.editoropen=!0,a(this.controls.number).text(b+1)},fetchNewTextTile:function(a,b,d,e){var f=M.cfg.wwwroot+"/lib/editor/atto/plugins/subtitle/pix/e/",g="<div class='poodllsubtitle_tt subtitleset_block'>";g+="<div class='numb_song'>@@dataid@@</div>",g+="<div class='subtitleset_time'>",g+="<div class='block_input'>",g+="<input type='text' name='name' value='@@start@@' readonly class='poodllsubtitle_tt_start'/>",g+="<div class='input_arr_block'>",g+="<div class='input_arr input_arr_top'></div>",g+="<div class='input_arr input_arr_bot'></div>",g+="</div>",g+="</div>",g+="<a href='#' class='now_btn'>Now</a>",g+="<div class='block_input'>",g+="<input type='text' name='name' value='@@end@@' readonly class='poodllsubtitle_tt_end'/>",g+="<div class='input_arr_block'>",g+="<div class='input_arr input_arr_top'></div>",g+="<div class='input_arr input_arr_bot'></div>",g+="</div>",g+="</div>",g+="<a href='#' class='now_btn'>Now</a>",g+="</div>",g+="<div class='subtitleset_text'>",g+="<div class='textarea poodllsubtitle_tt_part'>@@part@@</div>",g+="</div>",g+="<div class='subtitleset_btns'>",g+="<div class='subs_btn_block subs_basket'>",g+="<img src='"+f+"btn_ic_1.svg'/>",g+="</div>",g+="<div class='subs_btn_block subs_btn_menu'></div>",g+="<div class='subs_btn_block'>",g+="<img src='"+f+"btn_ic_2.svg'/>",g+="</div>",g+="<div class='subs_btn_block'>",g+="<img src='"+f+"btn_ic_3.svg'/>",g+="</div>",g+="</div>",g+="</div>";var h=c.ms2TimeString(b),i=c.ms2TimeString(d);return g.replace("@@start@@",h).replace("@@end@@",i).replace("@@part@@",e).replace("@@dataid@@",a+1)},fetchNewTextTileContainer:function(a,b,c,d){var e=this.fetchNewTextTile(a,b,c,d),f="<div data-id='@@dataid@@' class='poodllsubtitle_itemcontainer'>";return f+=e,f+="</div>",f.replace("@@dataid@@",a)},clearTiles:function(){this.controls.container.empty()},resetData:function(a){this.hideEditor(),this.clearTiles(),d.init(a),this.initTiles()},syncFrom:function(b){for(var c=d.fetchCount(),e=b;e<c;e++){var f=d.fetchItem(e),g=a(".poodllsubtitle_itemcontainer").filter(function(){return parseInt(a(this).attr("data-id"))==e});if(g.length>0)this.updateTextTile(g,f);else{var h=this.fetchNewTextTileContainer(e,f.start,f.end,f.part);this.controls.container.append(h)}}a(".poodllsubtitle_itemcontainer").filter(function(){return parseInt(a(this).attr("data-id"))>=c}).remove()},syncAt:function(a){},updateTextTile:function(b,d){var e=c.ms2TimeString(d.start),f=c.ms2TimeString(d.end);a(b).find(".poodllsubtitle_tt_start").text(e),a(b).find(".poodllsubtitle_tt_end").text(f),a(b).find(".poodllsubtitle_tt_part").text(d.part),a(b).find(".poodllsubtitle_tt_start").val(e),a(b).find(".poodllsubtitle_tt_end").val(f),a(b).find(".poodllsubtitle_tt_part").text(d.part)},highlightContainer:function(b){this.deHighlightAll();var c=a(".poodllsubtitle_itemcontainer").filter(function(){return parseInt(a(this).attr("data-id"))==b});c.addClass("activesubtitle")},deHighlightAll:function(){a(".poodllsubtitle_itemcontainer").removeClass("activesubtitle")},fetchSubtitleData:function(){return d.fetchSubtitleData()}}});