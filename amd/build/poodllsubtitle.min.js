define(["jquery","atto_subtitle/vtthelper","atto_subtitle/subtitleset","atto_subtitle/previewhelper","atto_subtitle/playerhelper"],function(a,b,c,d,e){return{controls:{},currentindex:!1,currentitemcontainer:null,editoropen:!1,init:function(a,b){c.init(a),d.init(c,b),e.init(b),this.initControls(),this.initTiles(),this.initEvents()},initControls:function(){this.controls.container=a("#poodllsubtitle_tiles"),this.controls.editor=a("#poodllsubtitle_editor"),this.controls.number=a("#poodllsubtitle_editor .numb_song"),this.controls.edstart=a("#poodllsubtitle_edstart"),this.controls.edend=a("#poodllsubtitle_edend"),this.controls.edpart=a("#poodllsubtitle_edpart"),this.controls.buttondelete=a("#poodllsubtitle_eddelete"),this.controls.buttonmergeup=a("#poodllsubtitle_edmergeup"),this.controls.buttonsplit=a("#poodllsubtitle_edsplit"),this.controls.buttonapply=a("#poodllsubtitle_edapply"),this.controls.buttoncancel=a("#poodllsubtitle_edcancel"),this.controls.buttonaddnew=a("#poodllsubtitle_addnew"),this.controls.buttonstartsetnow=a("#poodllsubtitle_startsetnow"),this.controls.buttonendsetnow=a("#poodllsubtitle_endsetnow")},hideEditor:function(){this.controls.editor.detach(),this.controls.editor.hide(),this.editoropen=!1},restoreTile:function(){var a=c.fetchItem(this.currentindex),b=this.fetchNewTextTile(this.currentindex,a.start,a.end,a.part);this.hideEditor(),this.currentitemcontainer.append(b)},editorToTile:function(){var d=b.timeString2ms(a(this.controls.edstart).val()),e=b.timeString2ms(a(this.controls.edend).val()),f=this.validateTimes(this.currentindex,d,e);if(!f)return a(this.currentitemcontainer).addClass("warning"),!1;var g=a(this.controls.edpart).val();c.updateItem(this.currentindex,d,e,g);var h=this.fetchNewTextTile(this.currentindex,d,e,g);return this.hideEditor(),this.currentitemcontainer.append(h),a(this.currentitemcontainer).removeClass("warning"),!0},initEvents:function(){var e=this;this.controls.container.on("click",".poodllsubtitle_tt",function(){var b=parseInt(a(this).parent().attr("data-id"));1==e.editoropen&&e.editorToTile(e.controls,e.currentindex,e.currentitemcontainer),e.currentindex=b,e.currentitemcontainer=a(this).parent(),e.shiftEditor(e.currentindex,e.currentitemcontainer),d.setPosition(e.currentindex)}),this.controls.buttondelete.click(function(){result=confirm("Warning! This tile is going to be deleted!"),result&&(e.restoreTile(),c.removeItem(e.currentindex),e.syncFrom(e.currentindex),d.updateLabel())}),this.controls.buttonmergeup.click(function(){e.editorToTile(),c.mergeUp(e.currentindex),e.syncFrom(e.currentindex-1),d.setPosition(e.currentindex-1)}),this.controls.buttonsplit.click(function(){e.editorToTile(),c.split(e.currentindex),e.syncFrom(e.currentindex),d.updateLabel()}),this.controls.buttonapply.click(function(){e.editorToTile(),d.updateLabel()}),this.controls.buttoncancel.click(function(){e.restoreTile()}),this.controls.buttonstartsetnow.click(function(){var a=d.fetchCurrentTime(),c=b.ms2TimeString(a);e.controls.edstart.val(c)}),this.controls.buttonendsetnow.click(function(){var a=d.fetchCurrentTime(),c=b.ms2TimeString(a);e.controls.edend.val(c)}),this.controls.buttonaddnew.click(function(){var a=c.fetchCount(),b=a,d=0;if(a>0){var f=c.fetchItem(a-1);d=f.end+500}var g=d+2e3;c.addItem(b,d,g,"");var h=e.fetchNewTextTileContainer(b,d,g,"");e.controls.container.append(h)}),d.highlightItem=this.highlightContainer,d.deHighlightAll=this.deHighlightAll},initTiles:function(){var a=this.controls.container,b=this,d=c.fetchCount();if(d>0)for(var e=0;e<d;e++){var f=c.fetchItem(e),g=b.fetchNewTextTileContainer(e,f.start,f.end,f.part);a.append(g)}},validateTimes:function(a,b,d){if(d<=b)return!1;var e=!1,f=!1;return a>0&&(e=c.fetchItem(a-1)),a<c.fetchCount()-1&&(f=c.fetchItem(a+1)),!(e&&e.end>b)&&!(f&&f.start<d)},shiftEditor:function(d,e){this.controls.editor.hide();var f=c.fetchItem(d),g=b.ms2TimeString(f.start);a(this.controls.edstart).val(g);var h=b.ms2TimeString(f.end);a(this.controls.edend).val(h);var i=f.part;a(this.controls.edpart).val(i),e.empty(),e.append(this.controls.editor),this.controls.editor.show(),this.editoropen=!0,a(this.controls.number).text(d+1)},fetchNewTextTile:function(a,c,d,e){var f=M.cfg.wwwroot+"/lib/editor/atto/plugins/subtitle/pix/e/",g="<div class='poodllsubtitle_tt subtitleset_block'>";g+="<div class='numb_song'>@@dataid@@</div>",g+="<div class='subtitleset_time'>",g+="<div class='block_input'>",g+="<input type='text' name='name' value='@@start@@' readonly class='poodllsubtitle_tt_start'/>",g+="<div class='input_arr_block'>",g+="<div class='input_arr input_arr_top'></div>",g+="<div class='input_arr input_arr_bot'></div>",g+="</div>",g+="</div>",g+="<a href='#' class='now_btn'>Now</a>",g+="<div class='block_input'>",g+="<input type='text' name='name' value='@@end@@' readonly class='poodllsubtitle_tt_end'/>",g+="<div class='input_arr_block'>",g+="<div class='input_arr input_arr_top'></div>",g+="<div class='input_arr input_arr_bot'></div>",g+="</div>",g+="</div>",g+="<a href='#' class='now_btn'>Now</a>",g+="</div>",g+="<div class='subtitleset_text'>",g+="<div class='textarea poodllsubtitle_tt_part'>@@part@@</div>",g+="</div>",g+="<div class='subtitleset_btns'>",g+="<div class='subs_btn_block subs_basket'>",g+="<img src='"+f+"btn_ic_1.svg'/>",g+="</div>",g+="<div class='subs_btn_block subs_btn_menu'></div>",g+="<div class='subs_btn_block'>",g+="<img src='"+f+"btn_ic_2.svg'/>",g+="</div>",g+="<div class='subs_btn_block'>",g+="<img src='"+f+"btn_ic_3.svg'/>",g+="</div>",g+="</div>",g+="</div>";var h=b.ms2TimeString(c),i=b.ms2TimeString(d);return g.replace("@@start@@",h).replace("@@end@@",i).replace("@@part@@",e).replace("@@dataid@@",a+1)},fetchNewTextTileContainer:function(a,b,c,d){var e=this.fetchNewTextTile(a,b,c,d),f="<div data-id='@@dataid@@' class='poodllsubtitle_itemcontainer'>";return f+=e,f+="</div>",f.replace("@@dataid@@",a)},clearTiles:function(){this.controls.container.empty()},resetData:function(a){this.hideEditor(),this.clearTiles(),c.init(a),this.initTiles()},syncFrom:function(b){for(var d=c.fetchCount(),e=b;e<d;e++){var f=c.fetchItem(e),g=a(".poodllsubtitle_itemcontainer").filter(function(){return parseInt(a(this).attr("data-id"))==e});if(g.length>0)this.updateTextTile(g,f);else{var h=this.fetchNewTextTileContainer(e,f.start,f.end,f.part);this.controls.container.append(h)}}a(".poodllsubtitle_itemcontainer").filter(function(){return parseInt(a(this).attr("data-id"))>=d}).remove()},syncAt:function(a){},updateTextTile:function(c,d){var e=b.ms2TimeString(d.start),f=b.ms2TimeString(d.end);a(c).find(".poodllsubtitle_tt_start").text(e),a(c).find(".poodllsubtitle_tt_end").text(f),a(c).find(".poodllsubtitle_tt_part").text(d.part),a(c).find(".poodllsubtitle_tt_start").val(e),a(c).find(".poodllsubtitle_tt_end").val(f),a(c).find(".poodllsubtitle_tt_part").text(d.part)},highlightContainer:function(b){this.deHighlightAll();var c=a(".poodllsubtitle_itemcontainer").filter(function(){return parseInt(a(this).attr("data-id"))==b});c.addClass("activesubtitle")},deHighlightAll:function(){a(".poodllsubtitle_itemcontainer").removeClass("activesubtitle")},fetchSubtitleData:function(){return c.fetchSubtitleData()}}});