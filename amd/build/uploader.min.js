define(["jquery"],function(a){return{upload_to_server:function(a,b,c,d){var e=new window.FormData,f=a.get("filepickeroptions").link,g=window.Object.keys(f.repositories),h="data:text/vtt;base64,"+this.unicodebtoa(b);h=this.dataURItoBlob(h),e.append("repo_upload_file",h,c),e.append("itemid",f.itemid);for(var i=0;i<g.length;i++)if("upload"===f.repositories[g[i]].type){e.append("repo_id",f.repositories[g[i]].id);break}e.append("env",f.env),e.append("sesskey",M.cfg.sesskey),e.append("client_id",f.client_id),e.append("savepath","/"),e.append("ctx_id",f.context.id);var j=M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload";this.make_xmlhttprequest(j,e,d)},make_xmlhttprequest:function(a,b,c){var d=new window.XMLHttpRequest;d.onreadystatechange=function(){4===d.readyState&&200===d.status?c("upload-ended",d.responseText):404===d.status&&c("upload-failed-404")},d.upload.onprogress=function(a){c(Math.round(a.loaded/a.total*100)+"% "+M.util.get_string("uploadprogress","atto_subtitle"))},d.upload.onerror=function(a){c("upload-failed",a)},d.upload.onabort=function(a){c("upload-aborted",a)},d.open("POST",a),d.send(b)},dataURItoBlob:function(a){for(var b=atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d),f=0;f<b.length;f++)e[f]=b.charCodeAt(f);var g=new Blob([d],{type:c});return g},unicodebtoa:function(a){return btoa(encodeURIComponent(a).replace(/%([0-9A-F]{2})/g,function(a,b){return String.fromCharCode("0x"+b)}))}}});